# 新年倒计时网站 - 项目规范与功能需求

## 项目概述
这是一个模仿 https://2026.xcodeman.com/ 的新年倒计时网站，具有动态烟花特效、背景音乐、倒计时器和弹幕祝福功能。

## 技术栈
- 纯前端：HTML + CSS + JavaScript (ES6 Modules)
- **Three.js r160** - WebGL 3D渲染
- **UnrealBloomPass** - 后期处理光晕效果（关键！）
- **EffectComposer** - 渲染管线
- **Canvas 2D** - 星空背景
- **Web Audio API** - 生成烟花爆炸深度音效
- **CSS Animation** - 弹幕效果
- **LocalStorage** - 持久化用户设置

## 源码参考
- 原网站：https://2026.xcodeman.com/
- CodePen源码：https://codepen.io/sabosugi/pen/ByzBXQW
- 本地源码备份：`docs/source_code/`

---

## 核心功能需求

### 1. 烟花效果
- **完全模仿原网站**的烟花爆炸效果
- 支持多种烟花类型：球形、环形、双层、柳叶、菊花、棕榈、心形、星形
- **3D深度感**：不同烟花有远近之分，近处烟花更大更亮
- **粒子拖尾效果**：粒子有运动轨迹
- **粒子闪烁**：随机闪烁效果增加真实感
- **默认参数（原网站配置）**：
  - particleCount: 23000
  - particleSize: 0.8
  - fadeSpeed: 0.00482
  - explosionForce: 3.3975
  - hoverDuration: 1.5
  - gravity: 0.00265

### 2. 烟花模式
- **舒缓模式** 🌙：烟花一个接一个放，缓慢节奏（每4秒发射1个），适合平时欣赏
- **激烈模式** 🎉：2-3个烟花快速连发（每0.8秒发射3个），适合跨年倒数或激动时刻
- 用户可在设置面板中切换模式
- 支持键盘快捷键：1=舒缓模式，2=激烈模式
- **模式配置参数**：
  - 舒缓模式：interval=4000ms, burstCount=1
  - 激烈模式：interval=800ms, burstCount=3, burstDelay=150ms

### 3. 定时切换
- 用户可设定在某个时间点自动切换烟花模式
- 例如：23:59 自动切换到激烈模式迎接新年
- 定时任务列表可增删管理

### 4. 音效系统
- **使用 Web Audio API 生成**深度爆炸音效（不是预录音频）
- 三层声音叠加：
  - 低频隆隆声（正弦波）
  - 白噪声爆裂声（带低通滤波器）
  - 短促咔嗒声（三角波）
- 音量可调节（0-1）
- 可一键开关音效

### 5. 交互功能
- **鼠标点击**：在点击位置爆炸烟花
- **鼠标跟随**：鼠标移动时有粒子跟随特效
- **空格键**：手动发射烟花
- **M键**：切换音效开关

### 6. 设置面板
- 点击右上角 ⚙️ 图标打开设置面板
- 设置面板与音量按钮**并列显示**，不重叠
- 面板内容：
  - **粒子设置**：粒子数量、粒子大小、淡出速度
  - **物理设置**：爆炸力度、悬停时间、重力
  - **深度音效**：启用开关、音量滑块
  - **重置按钮**：一键恢复默认值
  - **语言切换**：中文/English 双语支持
  - **模式选择**：舒缓/激烈模式切换
  - **定时切换**：添加/删除定时任务

### 7. 双语支持
- 设置面板支持中英文切换
- 所有文本标签都有对应翻译
- 用户语言偏好保存到 LocalStorage

### 8. 星空背景
- Canvas 实现动态星空效果
- 星星有远近大小之分
- 支持加速特效（boost）

### 9. 倒计时器
- 显示距离2026年的：天、时、分、秒
- 数字使用科技感字体（Orbitron）
- 到达新年时自动切换激烈模式并庆祝

### 10. 弹幕系统
- 预设祝福语随机飘过屏幕
- 用户输入愿望后以弹幕形式显示
- 用户弹幕有特殊高亮效果
- 弹幕分布均匀，不集中在某个区域

---

## UI/UX 要求

### 控制按钮
- 位于页面右上角
- 🔇/🔊 音量开关按钮
- ⚙️ 设置按钮
- 两个按钮**并列显示**，间距合适

### 设置面板样式
- 从右侧滑入
- 半透明磨砂玻璃效果
- 可折叠的分区（点击标题折叠/展开）
- 滑块显示当前数值
- 重置按钮使用红色调，易于辨识

### 整体风格
- 深色背景
- 紫色/青色渐变点缀
- 科技感字体
- 流畅的动画过渡

---

## 文件结构

```
happynewyear/
├── index.html          # 主页面
├── css/
│   └── style.css       # 样式文件
├── js/
│   ├── main.js         # 主逻辑
│   ├── fireworks.js    # 烟花系统
│   ├── starfield.js    # 星空背景
│   ├── countdown.js    # 倒计时
│   ├── danmaku.js      # 弹幕系统
│   ├── audio.js        # 音效系统
│   └── config.js       # 配置管理
├── DESIGN.md           # 设计文档
└── README.md           # 项目说明
```

---

## 关键实现细节

### 烟花粒子系统（基于CodePen源码）
- **粒子纹理**：32x32径向渐变圆形Sprite（`getSprite()`）
- **颜色系统**：Mono（单色）/ Dual（双色互补）/ Tri（三色）
- **球形分布**：`theta = random * 2π`, `phi = acos(2*random - 1)`
- **两阶段物理**：
  - 悬停期（hoverDuration）：高摩擦力 0.95494
  - 下落期：重力 + 低摩擦力 0.98
- **UnrealBloomPass**：后期处理光晕效果（bloomStrength: 1.495）
- **拖尾效果**：全屏半透明黑色Quad（opacity: 0.39707）
- **雾效**：`FogExp2(0x000000, 0.002)` 增加深度感

### 音效生成（Deep Boom Sound）
- **三层声音合成**：
  1. Sub-Bass Kick（正弦波 50Hz→20Hz，5秒）
  2. 白噪声爆裂（低通滤波150Hz→30Hz，4.5秒）
  3. 短促咔嗒声（三角波200Hz→50Hz，0.1秒）
- **DynamicsCompressor**：threshold=-10, knee=40, ratio=12
- **音量控制**：0-1可调节

### Three.js场景配置
- **相机**：PerspectiveCamera(60°, aspect, 0.1, 4000)
- **相机位置**：(0, 0, 150) - 俯视视角
- **背景星星**：3000个粒子，范围±600单位
- **渲染器**：antialias=false, pixelRatio≤1.5（性能优化）
- **Bloom参数**：strength=1.495, radius=0.5, threshold=0.0

### 配置持久化
- 使用 localStorage 保存用户设置
- 页面加载时自动恢复上次配置
- 重置功能清除自定义设置

---

## 快捷键汇总

| 按键 | 功能 |
|------|------|
| 空格 | 发射烟花 |
| M | 切换音效 |
| 1 | 舒缓模式 |
| 2 | 激烈模式 |
| ESC | 关闭设置面板 |

---

## 注意事项

1. **性能优化**：粒子数量虽然配置为23000，但每个烟花只使用其中一部分
2. **音频初始化**：需要用户交互后才能播放音频（浏览器策略）
3. **响应式设计**：适配不同屏幕尺寸
4. **无障碍**：按钮有 title 提示

---

## 源码来源与学习资源

### CodePen原始源码
- **URL**: https://codepen.io/sabosugi/pen/ByzBXQW
- **作者**: Sabo Sugi
- **标题**: Fireworks 2026 + Boom Sound
- **本地备份**: `docs/source_code/`

### 核心技术发现
1. **UnrealBloomPass** - Three.js后期处理，虚幻引擎级光晕
2. **简单Sprite** - 32x32径向渐变圆形，不是复杂水滴
3. **颜色系统** - 随机Mono/Dual/Tri（单/双/三色）
4. **悬停物理** - hoverDuration秒内高摩擦力，之后重力下落
5. **全屏Quad** - 半透明黑色平面实现拖尾效果
6. **场景雾效** - FogExp2增加深度和氛围

### Three.js关键API
```javascript
// 粒子系统
THREE.Points + THREE.PointsMaterial + THREE.BufferGeometry

// 后期处理
EffectComposer + RenderPass + UnrealBloomPass

// 纹理
THREE.CanvasTexture (动态生成Sprite)

// 数学工具
THREE.MathUtils.smoothstep (平滑过渡)
```

### 性能优化技巧
- `renderer.autoClearColor = false` - 手动控制清除
- `depthWrite: false` - 粒子不写入深度
- `AdditiveBlending` - GPU硬件叠加
- `pixelRatio ≤ 1.5` - 限制分辨率
- `antialias: false` - 关闭抗锯齿（性能优先）

---

*最后更新：2024-12-31*
*基于 CodePen sabosugi/ByzBXQW 源码*